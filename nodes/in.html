<script type="text/x-red" data-template-name="yeelight-in">
  <div class="form-row">
    <label for="node-input-name" class="l-width"><i class="icon-tag"></i><span data-i18n="label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]placeholder.name">
  </div>
  <div class='form-row'>
    <label for='node-input-device'><i class='fa fa-lightbulb-o'></i> <span data-i18n="label.device"></label>
    <select type='text' id='node-input-device' style='display: inline-block; vertical-align: middle; width:60%;'>
    </select>
    <button id='devices-reload'>reload</button>
  </div>
</script>

<style type="text/css">
  .node_label_white {
      fill: white;
  }
  .node_label_white_italic {
      fill: white;
      font-style: italic;
  }
  #palette_node_yeelight-in > div.palette_label {
      color: white;
  }
  </style>

<script type="text/javascript">
  RED.nodes.registerType('yeelight-in', {
    category: 'light',
    color: '#BA1F1F',
    defaults: {
      name: {
        value: ""
      },
      device: {
        required: true
      }
    },
    inputs: 0,
    outputs: 2,
    outputLabels: ["state", "homekit"],
    icon: "yeelight.png",
    label: function () {
      return this.name || "yeelight-in";
    },
    labelStyle: function () {
      return this.name ? "node_label_white_italic" : "node_label_white";
    },
    oneditprepare: function () {
      var node = this;

      $('#devices-reload').click(() => {
        fetchDevices(this);
      })

      fetchDevices(this)
    },
    oneditsave: function () {
      if ($('#node-input-device').attr('disabled')) {
        this.device = undefined
      }
    }
  });

  let devices = {}

  function optionForDevice(device, context) {
    console.log(device)
    const selected = (context.device && context.device.info && device.info.id == context.device.info.id) ? 'selected' :
      '';
    return `<option value='${device.info.id}' ${selected}>${device.address.ip} - ${device.info.name} - ${device.info.id}</option>`
  }

  function fetchDevices(context) {
    $.get('yeelight/devices', (fetchedDevices) => {
      if (fetchedDevices.error) {
        console.log(fetchedDevices.error)
        return;
      }

      devices = {}
      fetchedDevices.forEach((device) => {
        devices[device.info.id] = device
      })

      if (fetchedDevices.length > 0) {
        let html = fetchedDevices
          .map(device => optionForDevice(device, context))
          .reduce((a, b) => a + b)
        $('#node-input-device').html(html);
        $('#node-input-device').removeAttr('disabled')
      }
    }, 'json')
  }
</script>

<script type="text/x-red" data-help-name="yeelight-in">
  <p>Node helps to communicate with Yeelight wifi devices</p>
</script>